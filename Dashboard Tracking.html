<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pelacakan Ambulans</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .leaflet-container {
            background: #374151; /* bg-gray-700 */
            border-radius: 0.5rem;
        }
        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .status-tersedia { background-color: #22c55e; } /* green-500 */
        .status-menuju-lokasi { background-color: #f59e0b; } /* amber-500 */
        .status-mengangkut-pasien { background-color: #ef4444; } /* red-500 */
        .status-kembali { background-color: #3b82f6; } /* blue-500 */
        .status-offline { background-color: #6b7280; } /* gray-500 */

        .ambulance-icon {
            font-size: 24px;
            text-shadow: 0 0 5px black;
            text-align: center;
            line-height: 1;
        }
        /* Custom scrollbar for better dark mode look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="p-4 lg:p-6">

    <!-- Header -->
    <header class="flex-shrink-0 flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold text-white">Tracking Ambulans PK3d Melalui JakConnected</h1>
            <p id="current-time" class="text-sm text-gray-400">Memuat waktu...</p>
        </div>
        <div class="hidden md:flex items-center space-x-6 text-center">
            <div>
                <p class="text-2xl font-bold text-green-400" id="unit-tersedia">0</p>
                <p class="text-xs text-gray-400">Unit Tersedia</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-amber-400" id="kasus-aktif">0</p>
                <p class="text-xs text-gray-400">Kasus Aktif</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-red-400" id="pasien-diantar">0</p>
                <p class="text-xs text-gray-400">Pasien Diantar</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col gap-6 overflow-hidden">
        <!-- Top Section: Map and Task List -->
        <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-hidden">
            <div class="lg:col-span-2 h-full min-h-[300px] flex flex-col bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">RSUD Budhi Asih</h2>
                <div id="map" class="flex-grow rounded-lg"></div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col">
                <h2 class="text-xl font-semibold mb-3 text-white">Daftar Tugas Unit</h2>
                <div id="task-list" class="space-y-3 overflow-y-auto pr-2">
                    <p class="text-gray-400">Memuat data unit...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Patient Details Table -->
        <div class="flex-shrink-0 bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col max-h-[35vh]">
            <h2 class="text-xl font-semibold mb-3 text-white">Detail Pasien Dalam Penanganan</h2>
            <div class="overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3">No</th>
                            <th scope="col" class="px-4 py-3">No Booking</th>
                            <th scope="col" class="px-4 py-3">Nama Pasien</th>
                            <th scope="col" class="px-4 py-3">Unit</th>
                            <th scope="col" class="px-4 py-3">Rujukan Dari</th>
                            <th scope="col" class="px-4 py-3 text-center">Tracking</th>
                        </tr>
                    </thead>
                    <tbody id="patient-table-body">
                        <!-- Patient rows will be injected here -->
                    </tbody>
                </table>
                 <div id="patient-table-placeholder" class="text-center text-gray-500 py-8">
                    Tidak ada pasien dalam penanganan saat ini.
                </div>
            </div>
        </div>
    </main>

    <!-- Tracking Modal -->
    <div id="tracking-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center" style="z-index: 1001;">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Kronologi Perjalanan</h3>
                <button id="close-modal-btn" class="text-2xl leading-none text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="modal-content" class="p-6 max-h-[60vh] overflow-y-auto">
                <!-- Chronology items will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- INITIALIZATION ---
        const map = L.map('map').setView([-6.2088, 106.8456], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const ambulanceMarkers = {};

        // --- MOCK DATA ---
        const hospitals = [
            { name: "RSCM Kencana", lat: -6.1954, lon: 106.8452 },
            { name: "RS Pusat Pertamina", lat: -6.2386, lon: 106.7885 },
            { name: "RS Medistra", lat: -6.2415, lon: 106.8322 },
            { name: "RS Harapan Kita", lat: -6.1884, lon: 106.7915 }
        ];

        let ambulances = [
            { id: "AGD-001", status: "tersedia", lat: -6.1751, lon: 106.8272, crew: "Ahmad & Budi", patient: null, destination: null, eta: 0, bookingId: null, referral: null, chronology: [] },
            { id: "AGD-002", status: "tersedia", lat: -6.2607, lon: 106.8016, crew: "Citra & Doni", patient: null, destination: null, eta: 0, bookingId: null, referral: null, chronology: [] },
            { id: "AGD-003", status: "offline", lat: -6.2297, lon: 106.8063, crew: "Eka & Fajar", patient: null, destination: null, eta: 0, bookingId: null, referral: null, chronology: [] },
            { id: "AGD-005", status: "menuju-lokasi", lat: -6.2554, lon: 106.8052, crew: "Indra & Joko", patient: { name: "N/A" }, destination: null, eta: 12, targetLat: -6.2815, targetLon: 106.7922, bookingId: "BK-250701", referral: "Panggilan Darurat (Kby)", chronology: [{time: "08:40", status: "Menuju lokasi pasien di Kebayoran Baru"}, {time: "08:45", status: "Melewati area Senayan"}] },
            { id: "AGD-006", status: "mengangkut-pasien", lat: -6.1920, lon: 106.8490, crew: "Kiki & Lina", patient: { name: "Tn. Wijaya" }, destination: hospitals[3], eta: 25, targetLat: hospitals[3].lat, targetLon: hospitals[3].lon, bookingId: "BK-250702", referral: "RSIA Bunda", chronology: [
                {time: "08:10", status: "Menuju penjemputan pasien di Menteng"}, 
                {time: "08:25", status: "Pasien dijemput dari RSIA Bunda"},
                {time: "08:30", status: "Melewati Tugu Tani, lalin padat"},
                {time: "08:40", status: "Masuk tol via GT Cempaka Putih"},
                {time: "08:45", status: "Dalam tol, melewati Rawamangun"},
            ]},
        ];

        // --- UI RENDERING FUNCTIONS ---

        function getStatusInfo(status) {
            const info = {
                "tersedia": { text: "Tersedia", color: "green-500", icon: '✅' },
                "menuju-lokasi": { text: "Menuju Lokasi", color: "amber-500", icon: '➡️' },
                "mengangkut-pasien": { text: "Mengangkut Pasien", color: "red-500", icon: '🚑' },
                "kembali": { text: "Kembali ke Pangkalan", color: "blue-500", icon: '🔄' },
                "offline": { text: "Offline", color: "gray-500", icon: '🔌' }
            };
            return info[status] || info["offline"];
        }

        function renderTaskList() {
            const taskListEl = document.getElementById('task-list');
            taskListEl.innerHTML = '';
            const sortedAmbulances = [...ambulances].sort((a, b) => {
                const order = { "mengangkut-pasien": 1, "menuju-lokasi": 2, "kembali": 3, "tersedia": 4, "offline": 5 };
                return order[a.status] - order[b.status];
            });

            sortedAmbulances.forEach(amb => {
                const statusInfo = getStatusInfo(amb.status);
                const etaText = amb.eta > 0 ? `<span class="font-semibold text-amber-300">${amb.eta} min</span>` : '';
                const destinationText = amb.destination ? `ke ${amb.destination.name}` : (amb.status === 'menuju-lokasi' ? 'ke Lokasi' : '');
                const taskItem = document.createElement('div');
                taskItem.className = `p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors duration-200`;
                taskItem.onclick = () => focusOnAmbulance(amb.id);
                taskItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="status-dot status-${amb.status}"></span>
                            <span class="font-bold text-white">${amb.id}</span>
                        </div>
                        ${etaText}
                    </div>
                    <p class="text-sm text-gray-300 mt-1 ml-5">${statusInfo.text} ${destinationText}</p>
                `;
                taskListEl.appendChild(taskItem);
            });
        }

        function renderMapMarkers() {
            ambulances.forEach(amb => {
                const statusInfo = getStatusInfo(amb.status);
                const iconHtml = `<div class="ambulance-icon" style="color: ${statusInfo.color.split('-')[1] === '500' ? '#' + ({green:'22c55e', amber:'f59e0b', red:'ef4444', blue:'3b82f6', gray:'6b7280'}[statusInfo.color.split('-')[0]]) : 'white'};">${statusInfo.icon}</div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [30, 30], iconAnchor: [15, 15] });

                if (ambulanceMarkers[amb.id]) {
                    ambulanceMarkers[amb.id].setLatLng([amb.lat, amb.lon]).setIcon(customIcon);
                } else {
                    ambulanceMarkers[amb.id] = L.marker([amb.lat, amb.lon], { icon: customIcon }).addTo(map)
                        .on('click', () => focusOnAmbulance(amb.id));
                }
                ambulanceMarkers[amb.id].bindPopup(`<b>${amb.id}</b><br>Status: ${statusInfo.text}<br>Kru: ${amb.crew}`);
            });
        }

        function renderPatientTable() {
            const tableBody = document.getElementById('patient-table-body');
            const placeholder = document.getElementById('patient-table-placeholder');
            tableBody.innerHTML = '';
            
            const activePatients = ambulances.filter(a => a.status === 'mengangkut-pasien' || a.status === 'menuju-lokasi');

            if (activePatients.length === 0) {
                placeholder.style.display = 'block';
                return;
            }
            placeholder.style.display = 'none';

            activePatients.forEach((amb, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                row.innerHTML = `
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3 font-medium text-white">${amb.bookingId || '-'}</td>
                    <td class="px-4 py-3">${amb.patient.name}</td>
                    <td class="px-4 py-3">${amb.id}</td>
                    <td class="px-4 py-3">${amb.referral || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="showTrackingModal('${amb.id}')" class="font-medium text-blue-500 hover:underline">Lihat</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function focusOnAmbulance(ambulanceId) {
            const amb = ambulances.find(a => a.id === ambulanceId);
            if (amb) {
                map.flyTo([amb.lat, amb.lon], 15);
                ambulanceMarkers[amb.id].openPopup();
            }
        }

        function showTrackingModal(ambulanceId) {
            const amb = ambulances.find(a => a.id === ambulanceId);
            if (!amb || !amb.chronology) return;

            const modal = document.getElementById('tracking-modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = '';

            amb.chronology.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex items-start gap-4 mb-4';
                el.innerHTML = `
                    <div class="w-16 text-right text-amber-400 font-semibold flex-shrink-0">${item.time}</div>
                    <div class="relative">
                        <div class="h-4 w-4 bg-blue-500 rounded-full border-2 border-gray-800"></div>
                        <div class="absolute top-4 left-1/2 w-0.5 h-full bg-gray-600 -translate-x-1/2"></div>
                    </div>
                    <div>${item.status}</div>
                `;
                modalContent.appendChild(el);
            });
            // Remove the line from the last item
            if(modalContent.lastChild) {
                modalContent.querySelector('.flex:last-child .absolute').remove();
            }

            modal.style.display = 'flex';
        }

        function hideTrackingModal() {
            document.getElementById('tracking-modal').style.display = 'none';
        }
        document.getElementById('close-modal-btn').onclick = hideTrackingModal;
        document.getElementById('tracking-modal').onclick = (e) => {
            if (e.target.id === 'tracking-modal') {
                hideTrackingModal();
            }
        };

        function updateKPIs() {
            document.getElementById('unit-tersedia').textContent = ambulances.filter(a => a.status === 'tersedia').length;
            document.getElementById('kasus-aktif').textContent = ambulances.filter(a => a.status === 'menuju-lokasi' || a.status === 'mengangkut-pasien').length;
            document.getElementById('pasien-diantar').textContent = ambulances.filter(a => a.status === 'mengangkut-pasien').length;
        }

        function updateTime() {
            const timeEl = document.getElementById('current-time');
            const now = new Date();
            timeEl.textContent = now.toLocaleString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' WIB';
        }

        // --- SIMULATION LOGIC ---
        function simulateMovement() {
            ambulances.forEach(amb => {
                if (amb.status === 'offline') return;

                if (amb.targetLat && amb.targetLon) {
                    const moveFactor = 0.001;
                    const latDiff = amb.targetLat - amb.lat;
                    const lonDiff = amb.targetLon - amb.lon;
                    if (Math.abs(latDiff) > moveFactor) amb.lat += moveFactor * Math.sign(latDiff);
                    if (Math.abs(lonDiff) > moveFactor) amb.lon += moveFactor * Math.sign(lonDiff);
                }

                if (amb.eta > 0) {
                    amb.eta--;
                    if (amb.eta % 5 === 0 && amb.eta > 0 && Math.random() > 0.5) { // Add chronology entry every 5 minutes with 50% chance
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - amb.eta);
                        const time = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                        amb.chronology.push({time: time, status: `Dalam perjalanan menuju ${amb.destination ? amb.destination.name : 'lokasi'}`});
                    }
                    
                    if (amb.eta === 0) {
                        const now = new Date();
                        const time = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                        if (amb.status === 'menuju-lokasi') {
                            amb.status = 'mengangkut-pasien';
                            amb.destination = hospitals[Math.floor(Math.random() * hospitals.length)];
                            amb.targetLat = amb.destination.lat; amb.targetLon = amb.destination.lon;
                            amb.eta = 15 + Math.floor(Math.random() * 10);
                            amb.patient.name = "Tn. Budi";
                            amb.chronology.push({time: time, status: "Pasien dijemput, menuju " + amb.destination.name});
                        } else if (amb.status === 'mengangkut-pasien') {
                            amb.chronology.push({time: time, status: "Tiba di " + amb.destination.name});
                            amb.status = 'kembali';
                            amb.destination = null; amb.patient = null; amb.bookingId = null; amb.referral = null;
                            amb.targetLat = -6.1751; amb.targetLon = 106.8272;
                            amb.eta = 20;
                        } else if (amb.status === 'kembali') {
                            amb.status = 'tersedia';
                            amb.targetLat = null; amb.targetLon = null;
                            amb.chronology = [];
                        }
                    }
                }
            });

            if (Math.random() < 0.02) { // 2% chance
                const available = ambulances.find(a => a.status === 'tersedia');
                if (available) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                    available.status = 'menuju-lokasi';
                    available.patient = { name: "N/A" };
                    available.targetLat = -6.20 + (Math.random() - 0.5) * 0.2;
                    available.targetLon = 106.84 + (Math.random() - 0.5) * 0.2;
                    available.eta = 10 + Math.floor(Math.random() * 5);
                    available.bookingId = `BK-${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
                    available.referral = "Panggilan Darurat";
                    available.chronology = [{time: time, status: "Menuju penjemputan pasien"}];
                }
            }
        }

        // --- MAIN LOOP ---
        function updateDashboard() {
            simulateMovement();
            renderTaskList();
            renderMapMarkers();
            renderPatientTable();
            updateKPIs();
        }
        
        // Initial call
        updateDashboard();
        updateTime();
        
        setInterval(updateDashboard, 3000);
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
